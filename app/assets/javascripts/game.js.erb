var game = {},
    phaserGame;

game.run = function (numOfPlayers) {
  this.numOfPlayers = numOfPlayers;
  phaserGame = new Phaser.Game(800,
                               600,
                               Phaser.AUTO,
                               'gameDiv',
                               { preload: game.preload,
                                 create:  game.create,
                                 update:  game.update,
                                 render:  game.render }
  );
}

game.preload = function () {
  phaserGame.load.image('space', '<%= asset_path "space.jpg" %>');
  phaserGame.load.image('cloud', '<%= asset_path "cloud-sprite.png" %>');
  phaserGame.load.image('blueOrb', '<%= asset_path "safe_orb.png" %>');
  phaserGame.load.image('redOrb', '<%= asset_path "unsafe_orb.png" %>');
  phaserGame.load.image('heart', '<%= asset_path "heart-sprite.png" %>');
  phaserGame.load.image('hitBox', '<%= asset_path "red.jpg" %>');
  phaserGame.load.spritesheet('player1', '<%= asset_path "dude.png" %>', 32, 48);
  phaserGame.load.spritesheet('player2', '<%= asset_path "dude2.png" %>', 32, 48);
  phaserGame.load.image('gameover', '<%= asset_path "game_over.png" %>');
};

// Create helpers
game.createHealthBar = function (healthBar, player, playerNum) {
  var yCoord = 16 + (40 * (playerNum - 1));
  for (var i = 0; i < player.maxHealth; i++) {
    healthBar.create((i * 40) + 16, yCoord, 'heart');
  }
};

game.createOrbs = function (orbs, sprite) {
  for (var i = 0; i < Math.floor(Math.random() * 10 + 5); i++) {
    var orb = orbs.create(phaserGame.world.randomX, 0, sprite);
    orb.body.gravity.y = 100;
    orb.body.bounce.y = 0.7 + Math.random() * 0.2;
    orb.lifespan = 10000;
  }
};

game.create = function () {

  // Create World
  phaserGame.world.setBounds(0, 0, 1280, 600);
  phaserGame.physics.startSystem(Phaser.Physics.ARCADE);
  phaserGame.add.sprite(0, 0, 'space');
  // Platforms
  game.platforms = phaserGame.add.group();
  game.platforms.enableBody = true;
  // Ground
  var ground = game.platforms.create(0, phaserGame.world.height + 60);
  ground.scale.setTo(100, 1);
  ground.body.immovable = true;
  // Cloud
  game.cloud = game.platforms.create(400, 400, 'cloud');
  game.cloud.body.immovable = true;
  game.cloud.body.setSize(90,35);
  game.cloud.lifespan = 10000;

  // Create Players
  var xCoord = game.cloud.x + ((game.cloud.body.sourceWidth / 4) * 3) // right edge of cloud
  game.player1 = new Player(phaserGame, xCoord, 0, 'player1');
  phaserGame.physics.arcade.enable(game.player1.sprite);
  game.player1.enterGame();
  game.player1.setSpriteMotion();
  // Health bar
  game.p1HealthBar = phaserGame.add.group();
  game.p1HealthBar.fixedToCamera = true;
  game.createHealthBar(game.p1HealthBar, game.player1, 1);
  // Keyboard
  game.player1.keys = phaserGame.input.keyboard.createCursorKeys();
  // Player 2
  if (game.numOfPlayers === 2) {
    var xCoord = game.cloud.x + (game.cloud.body.sourceWidth / 4) // left edge of cloud
    game.player2 = new Player(phaserGame, xCoord, 0, 'player2');
    phaserGame.physics.arcade.enable(game.player2.sprite);
    game.player2.enterGame();
    game.player2.setSpriteMotion();

    game.p2HealthBar = phaserGame.add.group();
    game.p2HealthBar.fixedToCamera = true;
    game.createHealthBar(game.p2HealthBar, game.player2, 2);

    game.player2.keys = [];
    game.player2.keys.push(phaserGame.input.keyboard.addKey(Phaser.Keyboard.A));
    game.player2.keys.push(phaserGame.input.keyboard.addKey(Phaser.Keyboard.D));
  }

  // Set Camera
  phaserGame.camera.follow(game.player1.sprite, 2);

  // Create Blue Orbs
  game.blueOrbs = phaserGame.add.group();
  game.blueOrbs.enableBody = true;
  phaserGame.time.events.loop(Phaser.Timer.SECOND * 3, game.createOrbs(game.blueOrbs, 'blueOrb'), phaserGame);

  // Create Red Orbs
  game.redOrbs = phaserGame.add.group();
  game.redOrbs.enableBody = true;
  phaserGame.time.events.loop(Phaser.Timer.SECOND * 5, game.createOrbs(game.redOrbs, 'redOrb'), phaserGame);
};

game.update = function () {

};

game.render = function () {

};
